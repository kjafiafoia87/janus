FROM python:3.11-slim

WORKDIR /app

ENV PIP_DEFAULT_TIMEOUT=180 \
    PIP_RETRIES=5 \
    PIP_NO_CACHE_DIR=1

# ğŸ”§ Utiles pour debug
RUN apt-get update && apt-get install -y curl && apt-get clean

# ğŸ” Ã‰tape 1 : copier requirements pour forcer le cache
COPY requirements.txt .

# ğŸ’£ Ã‰tape 2 : supprimer toute version installÃ©e (par prÃ©caution)
RUN pip uninstall -y elasticsearch || true

# âœ… Ã‰tape 3 : installer explicitement la bonne version
RUN pip install "elasticsearch>=8.12.0"

# ğŸ‘€ Ã‰tape 4 : vÃ©rifier la version active
RUN python -c "import elasticsearch; print('âœ… ES version:', elasticsearch.__version__)"

# ğŸ“¦ Ã‰tape 5 : installer les autres dÃ©pendances
RUN pip install -r requirements.txt

# Copier le code
COPY . .

# Rendre le script de dÃ©marrage exÃ©cutable
RUN chmod +x /app/entrypoint.sh

ENTRYPOINT ["./entrypoint.sh"]